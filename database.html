<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฐานข้อมูลสมาชิก - PhoneZone Database</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/enhanced.css">
    <link rel="stylesheet" href="assets/css/auth.css">
    <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
    <div class="gold-glow"></div>
    <div class="floating-shapes"></div>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>ฐานข้อมูลสมาชิก</h1>
        </div>

        <!-- Admin Login Section -->
        <div id="adminLoginSection" class="admin-section">
            <form id="adminForm" style="text-align:center; margin-bottom:2rem;">
                <div class="form-group" style="max-width: 400px; margin: 0 auto;">
                    <label for="adminPassword">รหัสผ่าน Admin</label>
                    <input type="password" id="adminPassword" placeholder="กรอกรหัสผ่าน Admin" required>
                </div>
                <button type="submit" class="submit-button" style="max-width: 400px;">เข้าสู่ระบบ Admin</button>
            </form>
        </div>

        <!-- User Table Section -->
        <div id="userTableSection" class="admin-section">
            <div class="search-filter-section">
                <input type="text" id="searchInput" class="search-input" placeholder="ค้นหาสมาชิก..." style="display: none;">
                <select id="filterSelect" class="filter-select" style="display: none;">
                    <option value="">ทั้งหมด</option>
                    <option value="active">ใช้งานอยู่</option>
                    <option value="inactive">ไม่ใช้งาน</option>
                </select>
            </div>
            
            <div class="table-container">
                <table id="userTable" class="data-table">
                    <thead>
                        <tr>
                            <th>UserID</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Tel</th>
                            <th id="actionHeader" style="display:none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ข้อมูลจะถูกเติมที่นี่ -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="result"></div>
        
        <!-- Navigation Section -->
        <div class="nav">
            <a href="index.html">
                <button type="button" class="submit-button">สมัครสมาชิก</button>
            </a>
            <a href="login.html">
                <button type="button" class="submit-button">เข้าสู่ระบบ</button>
            </a>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://ooioxfihdgwtcnvvsqpm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vaW94ZmloZGd3dGNudnZzcXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3OTQwNjMsImV4cCI6MjA2OTM3MDA2M30.xvKhayfCkiO8Wt5IRUDZF4MrzCUZeFB4YvPqKQmMdXQ';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        let isAdmin = false;
        const ADMIN_PASSWORD = "AdminPassword"; // เปลี่ยนรหัสนี้ตามต้องการ

        document.getElementById('adminForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const input = document.getElementById('adminPassword').value;
            const resultDiv = document.getElementById('result');
            
            if (input === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('actionHeader').style.display = '';
                document.getElementById('searchInput').style.display = 'block';
                document.getElementById('filterSelect').style.display = 'block';
                
                resultDiv.className = 'success';
                resultDiv.innerText = 'เข้าสู่ระบบ Admin สำเร็จ!';
                
                loadUsers();
                
                setTimeout(() => {
                    resultDiv.innerText = '';
                    resultDiv.className = '';
                }, 3000);
            } else {
                resultDiv.className = 'error';
                resultDiv.innerText = 'รหัสผ่าน Admin ไม่ถูกต้อง';
                
                setTimeout(() => {
                    resultDiv.innerText = '';
                    resultDiv.className = '';
                }, 3000);
            }
        });

        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('Information_User')
                    .select('*')
                    .order('UserID', { ascending: true });
                    
                if (error) {
                    document.getElementById('result').className = 'error';
                    document.getElementById('result').innerText = 'เกิดข้อผิดพลาด: ' + error.message;
                    return;
                }
                
                const tbody = document.querySelector('#userTable tbody');
                tbody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(user => {
                        const tr = document.createElement('tr');
                        if (isAdmin) {
                            tr.innerHTML = `
                                <td data-label="UserID">${user.UserID ?? ''}</td>
                                <td data-label="Username" contenteditable="true">${user.Username ?? ''}</td>
                                <td data-label="Password" contenteditable="true" style="font-family:monospace;">${user.Password ?? ''}</td>
                                <td data-label="Name" contenteditable="true">${user.Name ?? ''}</td>
                                <td data-label="Surname" contenteditable="true">${user.Surname ?? ''}</td>
                                <td data-label="Tel" contenteditable="true">${user.Tel ?? ''}</td>
                                <td data-label="Actions">
                                    <button onclick="saveUser(this, '${user.UserID}')" class="action-btn primary" style="margin-right:0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem;">บันทึก</button>
                                    <button onclick="deleteUser('${user.UserID}')" class="action-btn danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">ลบ</button>
                                </td>
                            `;
                        } else {
                            tr.innerHTML = `
                                <td data-label="UserID">${user.UserID ?? ''}</td>
                                <td data-label="Username">${user.Username ?? ''}</td>
                                <td data-label="Password" style="font-family:monospace;">${'*'.repeat(user.Password?.length || 0)}</td>
                                <td data-label="Name">${user.Name ?? ''}</td>
                                <td data-label="Surname">${user.Surname ?? ''}</td>
                                <td data-label="Tel">${user.Tel ?? ''}</td>
                                <td data-label="Actions"></td>
                            `;
                        }
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="7" style="text-align: center; color: rgba(255,255,255,0.6);">ไม่มีข้อมูลสมาชิก</td>';
                    tbody.appendChild(tr);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('result').className = 'error';
                document.getElementById('result').innerText = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
            }
        }

        async function saveUser(btn, userId) {
            try {
                const tr = btn.parentElement.parentElement;
                const Username = tr.children[1].innerText.trim();
                const Password = tr.children[2].innerText.trim();
                const Name = tr.children[3].innerText.trim();
                const Surname = tr.children[4].innerText.trim();
                const Tel = tr.children[5].innerText.trim();

                // Add loading state to button
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'กำลังบันทึก...';

                const { error } = await supabaseClient
                    .from('Information_User')
                    .update({
                        Username,
                        Password,
                        Name,
                        Surname,
                        Tel
                    })
                    .eq('UserID', userId);

                btn.disabled = false;
                btn.textContent = originalText;

                if (error) {
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                } else {
                    // Show success message
                    const resultDiv = document.getElementById('result');
                    resultDiv.className = 'success';
                    resultDiv.innerText = 'บันทึกข้อมูลเรียบร้อยแล้ว';
                    
                    setTimeout(() => {
                        resultDiv.innerText = '';
                        resultDiv.className = '';
                    }, 3000);
                    
                    // Reload data to refresh the table
                    loadUsers();
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('คุณต้องการลบข้อมูลนี้ใช่หรือไม่?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('Information_User')
                    .delete()
                    .eq('UserID', userId);

                if (error) {
                    document.getElementById('result').className = 'error';
                    document.getElementById('result').innerText = 'เกิดข้อผิดพลาด: ' + error.message;
                } else {
                    // Show success message
                    const resultDiv = document.getElementById('result');
                    resultDiv.className = 'success';
                    resultDiv.innerText = 'ลบข้อมูลเรียบร้อยแล้ว';
                    
                    setTimeout(() => {
                        resultDiv.innerText = '';
                        resultDiv.className = '';
                    }, 3000);
                    
                    // Reload data to refresh the table
                    loadUsers();
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                document.getElementById('result').className = 'error';
                document.getElementById('result').innerText = 'เกิดข้อผิดพลาดในการลบข้อมูล';
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#userTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Load users on page load (limited view for non-admin)
        loadUsers();
    </script>
</body>
</html>
